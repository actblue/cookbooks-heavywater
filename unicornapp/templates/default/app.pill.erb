Bluepill.application("app") do |app|
  app.process("unicorn") do |process|
    process.pid_file = "/var/run/unicorn/unicorn.pid"
    process.working_dir = "/var/www/current"

    process.start_command = "unicorn_rails --daemonize --env <%= @environment %> --config-file /etc/unicorn/app.rb"
    process.stop_command = "kill -QUIT {{PID}}"
    process.restart_command = "kill -USR2 {{PID}}; sleep 3;" +
      "kill -WINCH {{PID}}; sleep 3;" +
      "kill -QUIT {{PID}}"

    process.uid = process.gid = 'www-data'

    process.start_grace_time = 8.seconds
    process.stop_grace_time = 3.seconds
    process.restart_grace_time = 15.seconds

    process.monitor_children do |child_process|
      child_process.stop_command = "kill -QUIT {{PID}}"

      child_process.checks :mem_usage, :every => 30.seconds, :below => 150.megabytes, :times => [3,4], :fires => :stop
      child_process.checks :cpu_usage, :every => 30.seconds, :below => 20, :times => [3,4], :fires => :stop
    end
  end
end
